<h1>Listings</h1>

<%= form_with url: listings_path, method: :get, local: true do %>
  <div class="filters">
    <div class="field">
      <%= label_tag :q, "Search" %>
      <%= text_field_tag :q, params[:q], placeholder: "Search by title or description" %>
    </div>

    <div class="field">
      <%= label_tag :category, "Category" %>
      <%= select_tag :category,
          options_for_select([["All Categories", ""]] + (@categories || []).map { |c| [c, c] }, params[:category]),
          include_blank: false %>
    </div>

    <div class="field">
      <%= label_tag :min_price, "Min Price ($)" %>
      <%= number_field_tag :min_price, params[:min_price], step: 0.01, placeholder: "0.00" %>
    </div>

    <div class="field">
      <%= label_tag :max_price, "Max Price ($)" %>
      <%= number_field_tag :max_price, params[:max_price], step: 0.01, placeholder: "No limit" %>
    </div>

    <div class="field">
      <%= label_tag :sort, "Sort By" %>
      <%= select_tag :sort, options_for_select(sort_options, params[:sort]), include_blank: false %>
    </div>

    <%= submit_tag "Filter", class: "btn" %>
    <% if params[:q].present? || params[:category].present? || params[:min_price].present? || params[:max_price].present? %>
      <%= link_to "Clear", listings_path, class: "btn-secondary" %>
    <% end %>
  </div>
<% end %>

<% if @listings.empty? %>
  <% if params[:q].present? || params[:category].present? || params[:min_price].present? || params[:max_price].present? %>
    <p>No listings found matching your filters.</p>
  <% else %>
    <p>No listings available.</p>
  <% end %>
<% else %>
  <% @listings.each do |listing| %>
    <div id="listing_<%= listing.id %>" style="margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px;">
      <% if listing.image.attached? %>
        <%= image_tag listing.image, alt: listing.title, style: "max-width: 200px; height: auto; margin-bottom: 10px; border-radius: 4px;" %>
      <% end %>
      <p>
        <%= link_to listing.title, listing_path(listing) %>
        - <%= number_to_currency(listing.price) %>
        <span class="category"><%= listing.category.presence || "Uncategorized" %></span>
      </p>
      <% if current_user && listing.user == current_user %>
        <%= link_to "Edit", edit_listing_path(listing) %>
        <%= link_to "Delete", listing_path(listing), data: { turbo_method: :delete, turbo_confirm: "Are you sure?" } %>
      <% end %>
    </div>
  <% end %>
<% end %>
